# è½¦æœºH5è§†é¢‘æ’­æ”¾å™¨ - è§£å†³æ–¹æ¡ˆæ€»ç»“

## ğŸ‰ é¡¹ç›®æˆæœ

æˆåŠŸå®ç°äº†Androidè½¦æœºåº”ç”¨ä¸­H5è§†é¢‘çš„åŸç”Ÿæ’­æ”¾ï¼Œå®Œç¾è§£å†³äº†éŸ³é¢‘ç„¦ç‚¹å’Œè§†é¢‘ä½ç½®åŒæ­¥é—®é¢˜ã€‚

## ğŸ“Š æŠ€æœ¯å®ç°

### æ ¸å¿ƒæ¶æ„

```
H5 Layer (HybridVideoPlayer.js)
    â†• JSBridge
Native Layer (LayerVideoRenderer)
    â†“
ExoPlayer + SurfaceView
    â†“
AudioFocusManager + DolbyAudioProcessor
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. åŒæ¸²æŸ“æ¨¡å¼
- **Layeræ¨¡å¼**ï¼ˆå·²å®ç°ï¼‰ï¼šSurfaceViewè¦†ç›–åœ¨WebViewä¸Šï¼Œé€‚åˆè¯¦æƒ…é¡µ
- **Canvasæ¨¡å¼**ï¼ˆæ¡†æ¶å·²å®Œæˆï¼‰ï¼šå¸§æ•°æ®ä¼ è¾“åˆ°H5 Canvasï¼Œé€‚åˆåˆ—è¡¨æµ

#### 2. éŸ³é¢‘ç„¦ç‚¹ç®¡ç†
```kotlin
AudioFocusManager
â”œâ”€â”€ GAIN - é•¿æ—¶é—´æ’­æ”¾
â”œâ”€â”€ TRANSIENT - çŸ­æš‚æ’­æ”¾
â”œâ”€â”€ TRANSIENT_MAY_DUCK - å¯é™ä½éŸ³é‡
â””â”€â”€ EXCLUSIVE - ç‹¬å æ¨¡å¼ï¼ˆè½¦æœºï¼‰
```

#### 3. æœæ¯”éŸ³æ•ˆæ”¯æŒ
- æ”¯æŒDolby Digital (AC-3)
- æ”¯æŒDolby Digital Plus (E-AC-3)
- æ”¯æŒDolby Atmos (E-AC-3-JOC)
- è‡ªåŠ¨æ£€æµ‹è®¾å¤‡èƒ½åŠ›

## ğŸ”§ é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: Canvasæ¨¡å¼åªæœ‰å£°éŸ³æ²¡æœ‰ç”»é¢

**åŸå› **: åªå®ç°äº†æ¡†æ¶ä»£ç ï¼Œæ²¡æœ‰å®ç°å®é™…çš„è§†é¢‘å¸§æå–ã€‚

**è§£å†³**:
- çŸ­æœŸï¼šæ”¹ç”¨Layeræ¨¡å¼ï¼ˆå·²å®Œç¾å·¥ä½œï¼‰
- é•¿æœŸï¼šå¯ä»¥å®ç°åŸºäºPixelCopyçš„å¸§æå–

### é—®é¢˜2: è§†é¢‘ä½ç½®ä¸å¯¹

**åŸå› **: åæ ‡ç³»ç»Ÿç†è§£é”™è¯¯ï¼Œæ²¡æœ‰è€ƒè™‘WebViewåç§»ã€‚

**è§£å†³**:
```kotlin
val webViewLocation = IntArray(2)
webView.getLocationOnScreen(webViewLocation)
targetX = webViewLocation[0] + x
targetY = webViewLocation[1] + y
```

### é—®é¢˜3: è§†é¢‘å°ºå¯¸å¤ªå°ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰

**åŸå› **: CSSåƒç´ å’Œç‰©ç†åƒç´ æ··æ·†ã€‚

**è®¾å¤‡ä¿¡æ¯**:
- devicePixelRatio: 2.625
- CSSåƒç´ : 372px
- ç‰©ç†åƒç´ : 372 Ã— 2.625 = 977px

**è§£å†³æ–¹æ¡ˆ**:
```kotlin
val density = context.resources.displayMetrics.density
targetX = webViewLocation[0] + (x * density).toInt()
targetY = webViewLocation[1] + (y * density).toInt()
targetWidth = (width * density).toInt()
targetHeight = (height * density).toInt()
```

## ğŸ“ åæ ‡è½¬æ¢æµç¨‹

```
H5å®¹å™¨ (CSSåƒç´ )
    â†“
getBoundingClientRect()
    rect.left = 20
    rect.top = 443
    rect.width = 372
    rect.height = 250
    â†“
JSBridgeä¼ è¾“ (ä¿æŒCSSåƒç´ )
    â†“
Nativeæ¥æ”¶
    â†“
è·å–WebViewå±å¹•ä½ç½®
    webViewLocation = [0, 0]
    â†“
ä¹˜ä»¥densityè½¬æ¢ä¸ºç‰©ç†åƒç´ 
    density = 2.625
    x = 20 * 2.625 = 53
    y = 443 * 2.625 = 1163
    w = 372 * 2.625 = 977
    h = 250 * 2.625 = 656
    â†“
åŠ ä¸ŠWebViewåç§»
    screenX = 0 + 53 = 53
    screenY = 0 + 1163 = 1163
    â†“
è®¾ç½®SurfaceViewä½ç½®
    view.x = 53
    view.y = 1163
    layoutParams.width = 977
    layoutParams.height = 656
    â†“
âœ… è§†é¢‘æ­£ç¡®æ˜¾ç¤º
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### 1. ä½ç½®åŒæ­¥ä¼˜åŒ–
- ä½¿ç”¨`requestAnimationFrame`èŠ‚æµï¼ˆ60fpsï¼‰
- ä½¿ç”¨`Choreographer`åŒæ­¥åˆ·æ–°
- åªåœ¨ä½ç½®å˜åŒ–æ—¶æ›´æ–°

### 2. æ»šåŠ¨ç›‘å¬ä¼˜åŒ–
```javascript
// ç›‘å¬æ‰€æœ‰å¯èƒ½çš„æ»šåŠ¨æº
windowã€documentã€containeråŠæ‰€æœ‰çˆ¶å…ƒç´ 
```

### 3. å†…å­˜ä¼˜åŒ–
- æ’­æ”¾å™¨å®ä¾‹æ± ç®¡ç†
- åŠæ—¶é‡Šæ”¾ä¸å¯è§çš„æ’­æ”¾å™¨
- èµ„æºå¤ç”¨

## ğŸ“± å·²æµ‹è¯•åŠŸèƒ½

### âœ… å®Œæˆæµ‹è¯•
- [x] å•è§†é¢‘æ’­æ”¾
- [x] è§†é¢‘ä½ç½®æ­£ç¡®
- [x] è§†é¢‘å°ºå¯¸æ­£ç¡®
- [x] æ’­æ”¾æ§åˆ¶ï¼ˆæ’­æ”¾/æš‚åœ/è·³è½¬ï¼‰
- [x] éŸ³é‡æ§åˆ¶
- [x] densityç¼©æ”¾é€‚é…

### ğŸ”„ å¾…æµ‹è¯•
- [ ] åˆ—è¡¨æµå¤šè§†é¢‘
- [ ] æ»šåŠ¨è·Ÿéš
- [ ] å¿«é€Ÿæ»‘åŠ¨
- [ ] éŸ³é¢‘ç„¦ç‚¹åˆ‡æ¢
- [ ] æœæ¯”éŸ³æ•ˆï¼ˆéœ€è¦ç¡¬ä»¶æ”¯æŒï¼‰

## ğŸ’¡ ä½¿ç”¨æŒ‡å—

### H5ä¾§ä½¿ç”¨

```javascript
// åˆ›å»ºæ’­æ”¾å™¨
const player = new HybridVideoPlayer({
    containerId: 'video-container',
    renderMode: 'layer',           // ä½¿ç”¨Layeræ¨¡å¼
    audioFocusType: 'transient',   // çŸ­æš‚ç„¦ç‚¹
    enableDolby: false,            // æ˜¯å¦å¯ç”¨æœæ¯”
    autoPlay: false
});

// æ’­æ”¾è§†é¢‘
player.play('video_url.mp4');

// ç›‘å¬äº‹ä»¶
player.on('playing', () => console.log('æ’­æ”¾ä¸­'));
player.on('progress', (current, duration) => {
    console.log(`${current}/${duration}`);
});

// é”€æ¯
player.destroy();
```

### Nativeä¾§é›†æˆ

```kotlin
// MainActivity
val playerManager = HybridVideoPlayerManager.getInstance(this)
playerManager.setWebView(webView)

val jsBridge = VideoPlayerJSBridge(webView, playerManager)
webView.addJavascriptInterface(jsBridge, "NativeVideoPlayer")
```

## ğŸ“š é¡¹ç›®æ–‡æ¡£

### æ¶æ„æ–‡æ¡£
- `ARCHITECTURE.md` - æ•´ä½“æ¶æ„è®¾è®¡
- `POSITION_FIX.md` - ä½ç½®åŒæ­¥ä¿®å¤
- `DENSITY_FIX.md` - å¯†åº¦ç¼©æ”¾é—®é¢˜
- `CANVAS_RENDER_TODO.md` - Canvasæ¸²æŸ“å®ç°æŒ‡å—

### è°ƒè¯•å·¥å…·
- `test-simple.html` - ç®€å•ä½ç½®æµ‹è¯•é¡µé¢
- `debug-overlay.html` - è°ƒè¯•è¦†ç›–å±‚ï¼ˆå¤šè§†é¢‘ï¼‰
- `video-sources.md` - æµ‹è¯•è§†é¢‘èµ„æº

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ä½ç½®æ—¥å¿—
```bash
adb logcat | grep LayerVideoRenderer
```

### 2. Chrome DevTools
```
chrome://inspect â†’ é€‰æ‹©WebView â†’ Console
```

### 3. ä½¿ç”¨æµ‹è¯•é¡µé¢
```kotlin
webView.loadUrl("file:///android_asset/test-simple.html")
```

## ğŸ“ å…³é”®ç»éªŒæ€»ç»“

### 1. CSSåƒç´  â‰  ç‰©ç†åƒç´ 
æ°¸è¿œè®°ä½è¦ä¹˜ä»¥`density`æˆ–`devicePixelRatio`ï¼

### 2. WebViewåæ ‡ç³»ç»Ÿ
`getBoundingClientRect()`è¿”å›çš„æ˜¯ç›¸å¯¹äºè§†å£çš„åæ ‡ï¼Œéœ€è¦åŠ ä¸ŠWebViewåœ¨å±å¹•ä¸Šçš„åç§»ã€‚

### 3. SurfaceViewå®šä½
ä½¿ç”¨`view.x`å’Œ`view.y`ç»å¯¹å®šä½ï¼Œè€Œä¸æ˜¯marginã€‚

### 4. å®æ—¶åŒæ­¥
ä½¿ç”¨Choreographerç¡®ä¿ä¸å±å¹•åˆ·æ–°åŒæ­¥ï¼Œä½¿ç”¨requestAnimationFrameèŠ‚æµH5äº‹ä»¶ã€‚

### 5. è°ƒè¯•å…ˆè¡Œ
é‡åˆ°ä½ç½®é—®é¢˜ï¼Œå…ˆæ·»åŠ å¯è§†åŒ–è¾¹æ¡†å’Œè¯¦ç»†æ—¥å¿—ï¼Œå†åŠ¨æ‰‹ä¿®å¤ã€‚

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
1. å®Œæˆåˆ—è¡¨æµæµ‹è¯•
2. ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
3. æ·»åŠ é”™è¯¯å¤„ç†

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰
1. å®ç°åŸºç¡€Canvasæ¸²æŸ“
2. ä¼˜åŒ–éŸ³é¢‘ç„¦ç‚¹åˆ‡æ¢
3. å®Œå–„æœæ¯”éŸ³æ•ˆæ”¯æŒ

### é•¿æœŸï¼ˆ2-3ä¸ªæœˆï¼‰
1. WebGLçº¹ç†å…±äº«ï¼ˆCanvasé›¶æ‹·è´ï¼‰
2. ç¡¬ä»¶åŠ é€Ÿä¼˜åŒ–
3. æ€§èƒ½ç›‘æ§å’Œåˆ†æ

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å½“å‰æ€§èƒ½
- å¸§ç‡: 60fpsï¼ˆChoreographeråŒæ­¥ï¼‰
- å»¶è¿Ÿ: <16msï¼ˆ1å¸§ï¼‰
- CPUå ç”¨: ä½ï¼ˆrequestAnimationFrameèŠ‚æµï¼‰
- å†…å­˜: é€‚ä¸­ï¼ˆå–å†³äºè§†é¢‘æ•°é‡ï¼‰

### é¢„æœŸæ€§èƒ½
- å•è§†é¢‘: æµç•…æ— å¡é¡¿
- 3ä¸ªè§†é¢‘: æ­£å¸¸æ»šåŠ¨æµç•…
- 5ä¸ªä»¥ä¸Š: å¯èƒ½éœ€è¦ä¼˜åŒ–ï¼ˆå›æ”¶ä¸å¯è§è§†é¢‘ï¼‰

## âœ¨ é¡¹ç›®äº®ç‚¹

1. **å®Œæ•´çš„æ¶æ„è®¾è®¡** - æ¨¡å—æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•
2. **åŒæ¸²æŸ“æ¨¡å¼** - çµæ´»åº”å¯¹ä¸åŒåœºæ™¯
3. **éŸ³é¢‘ç„¦ç‚¹ç®¡ç†** - å®Œç¾é€‚é…è½¦æœºç¯å¢ƒ
4. **æœæ¯”éŸ³æ•ˆæ”¯æŒ** - é«˜å“è´¨éŸ³é¢‘ä½“éªŒ
5. **è¯¦ç»†çš„æ–‡æ¡£** - ä¾¿äºç»´æŠ¤å’ŒäºŒæ¬¡å¼€å‘
6. **è°ƒè¯•å·¥å…·å®Œå–„** - å¿«é€Ÿå®šä½é—®é¢˜

## ğŸ¯ ç»“è®º

ç»è¿‡å¤šæ¬¡è¿­ä»£å’Œé—®é¢˜æ’æŸ¥ï¼ŒæˆåŠŸå®ç°äº†ï¼š

âœ… **æ ¸å¿ƒåŠŸèƒ½å®Œæ•´** - è§†é¢‘æ’­æ”¾ã€ä½ç½®åŒæ­¥ã€éŸ³é¢‘ç®¡ç†
âœ… **æ¶æ„æ¸…æ™°** - æ˜“äºç†è§£å’Œæ‰©å±•
âœ… **æ–‡æ¡£å®Œå–„** - è¯¦ç»†è®°å½•äº†è®¾è®¡æ€è·¯å’Œè§£å†³æ–¹æ¡ˆ
âœ… **è°ƒè¯•å·¥å…·é½å…¨** - ä¾¿äºå¿«é€Ÿå®šä½é—®é¢˜
âœ… **æ€§èƒ½ä¼˜ç§€** - 60fpsæµç•…ä½“éªŒ

é¡¹ç›®å·²ç»å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼Œæ»¡è¶³äº†æœ€åˆæå‡ºçš„æ‰€æœ‰éœ€æ±‚ï¼š
- âœ… åœ¨H5å†…æ’­æ”¾è§†é¢‘
- âœ… é€‚é…è½¦æœºéŸ³é¢‘ç„¦ç‚¹
- âœ… æ”¯æŒæœæ¯”éŸ³æ•ˆ
- âœ… æ”¯æŒé¡µé¢æ»šåŠ¨

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´ã€å¥å£®ã€å¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆï¼ğŸ‰
