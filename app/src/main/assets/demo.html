<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ··åˆè§†é¢‘æ’­æ”¾å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            padding-top: 180px;
        }

        /* Material Designå¡ç‰‡ */
        .card {
            background: white;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15), 0 6px 12px rgba(0,0,0,0.1);
        }

        .card-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .card-header h1 {
            font-size: 28px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .card-content {
            padding: 20px;
        }

        /* æ‚¬æµ®æ—¥å¿— */
        .log-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            padding: 16px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .log {
            max-height: 100px;
            overflow-y: auto;
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
        }

        .log-item {
            margin-bottom: 4px;
        }

        .log-item.info { color: #2196F3; }
        .log-item.success { color: #4CAF50; }
        .log-item.error { color: #F44336; }

        /* Tabåˆ‡æ¢ */
        .tabs {
            display: flex;
            gap: 0;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            background: #f5f5f5;
        }

        .tab {
            flex: 1;
            padding: 16px;
            background: #f5f5f5;
            border: none;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
            position: relative;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* è§†é¢‘åˆ—è¡¨é¡¹ */
        .video-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .video-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .video-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .video-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .video-meta {
            font-size: 12px;
            color: #999;
        }

        .video-container {
            width: 100%;
            height: 220px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        /* æŒ‰é’®æ ·å¼ */
        button, .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        button:hover, .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        button:active, .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #5AC8FA 0%, #4A90E2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56CCF2 0%, #2F80ED 100%);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Switchå¼€å…³ */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .switch-label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        /* Selectæ§ä»¶ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            margin-bottom: 8px;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 16px;
        }

        /* è§†é¢‘æ§åˆ¶æŒ‰é’®ç»„ */
        .video-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.1s linear;
        }

        .status {
            font-size: 13px;
            color: #666;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-top: 8px;
        }

        /* å›¾æ ‡ */
        .icon {
            font-style: normal;
        }
    </style>
</head>
<body>
    <!-- æ‚¬æµ®æ—¥å¿— -->
    <div class="log-container">
        <div class="log-header">
            <span class="log-title">ğŸ“‹ äº‹ä»¶æ—¥å¿—</span>
            <button class="btn-small btn-secondary" onclick="clearLog()">æ¸…ç©º</button>
        </div>
        <div id="log" class="log"></div>
    </div>

    <!-- ä¸»æ ‡é¢˜å¡ç‰‡ -->
    <div class="card">
        <div class="card-header">
            <h1>ğŸ¬ æ··åˆè§†é¢‘æ’­æ”¾å™¨</h1>
        </div>
    </div>

    <!-- Tabåˆ‡æ¢ -->
    <div class="card">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('canvas')">Canvasæ¨¡å¼</button>
            <button class="tab" onclick="switchTab('layer')">Layeræ¨¡å¼</button>
        </div>

        <!-- Canvasæ¨¡å¼Tab -->
        <div id="tab-canvas" class="tab-content active">
            <div class="card-content">
                <!-- è‡ªåŠ¨æ’­æ”¾å¼€å…³ -->
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="autoPlaySwitch" checked onchange="toggleAutoPlay()">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label">åˆ—è¡¨æ»‘åŠ¨è‡ªåŠ¨åˆ‡æ¢æ’­æ”¾</span>
                </div>

                <!-- è§†é¢‘åˆ—è¡¨ -->
                <div class="video-item">
                    <div class="video-item-header">
                        <div>
                            <div class="video-title">è§†é¢‘ 1 - é£æ™¯</div>
                            <div class="video-meta">æ—¶é•¿: 01:20 | è§‚çœ‹: 1.2K</div>
                        </div>
                    </div>
                    <div id="video-list-1" class="video-container"></div>
                    <div class="video-controls">
                        <button class="btn-primary btn-small" onclick="playVideo(0)">
                            <span class="icon">â–¶</span> æ’­æ”¾
                        </button>
                        <button class="btn-secondary btn-small" onclick="pauseVideo(0)">
                            <span class="icon">â¸</span> æš‚åœ
                        </button>
                    </div>
                </div>

                <div class="video-item">
                    <div class="video-item-header">
                        <div>
                            <div class="video-title">è§†é¢‘ 2 - åŸå¸‚</div>
                            <div class="video-meta">æ—¶é•¿: 02:15 | è§‚çœ‹: 3.4K</div>
                        </div>
                    </div>
                    <div id="video-list-2" class="video-container"></div>
                    <div class="video-controls">
                        <button class="btn-primary btn-small" onclick="playVideo(1)">
                            <span class="icon">â–¶</span> æ’­æ”¾
                        </button>
                        <button class="btn-secondary btn-small" onclick="pauseVideo(1)">
                            <span class="icon">â¸</span> æš‚åœ
                        </button>
                    </div>
                </div>

                <div class="video-item">
                    <div class="video-item-header">
                        <div>
                            <div class="video-title">è§†é¢‘ 3 - äººç‰©</div>
                            <div class="video-meta">æ—¶é•¿: 03:40 | è§‚çœ‹: 5.6K</div>
                        </div>
                    </div>
                    <div id="video-list-3" class="video-container"></div>
                    <div class="video-controls">
                        <button class="btn-primary btn-small" onclick="playVideo(2)">
                            <span class="icon">â–¶</span> æ’­æ”¾
                        </button>
                        <button class="btn-secondary btn-small" onclick="pauseVideo(2)">
                            <span class="icon">â¸</span> æš‚åœ
                        </button>
                    </div>
                </div>

                <!-- å…¨å±€æ§åˆ¶ -->
                <div class="settings-panel">
                    <div class="settings-title">âš™ï¸ å…¨å±€æ§åˆ¶</div>
                    <div class="video-controls">
                        <button class="btn-danger" onclick="pauseAllList()">
                            <span class="icon">â¸</span> å…¨éƒ¨æš‚åœ
                        </button>
                        <button class="btn-danger" onclick="destroyAllList()">
                            <span class="icon">ğŸ—‘</span> å…¨éƒ¨é”€æ¯
                        </button>
                    </div>
                </div>

                <!-- æ€§èƒ½è®¾ç½® -->
                <div class="settings-panel">
                    <div class="settings-title">ğŸ›ï¸ æ€§èƒ½è®¾ç½®</div>

                    <div class="form-group">
                        <label class="form-label">è§†é¢‘åˆ†è¾¨ç‡ï¼ˆé‡æ–°åˆ›å»ºæ’­æ”¾å™¨ç”Ÿæ•ˆï¼‰</label>
                        <select id="resolutionSelect">
                            <option value="240">240p (èŠ‚çœæµé‡)</option>
                            <option value="320" selected>320p (é»˜è®¤æ¨è)</option>
                            <option value="480">480p (æ›´æ¸…æ™°)</option>
                            <option value="640">640p (é«˜æ¸…)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å¸§ç‡æ§åˆ¶</label>
                        <select id="frameRateSelect" onchange="onFrameRateChange()">
                            <option value="disabled">å…³é—­éš”å¸§</option>
                            <option value="30">30 FPS</option>
                            <option value="20">20 FPS</option>
                            <option value="15">15 FPS</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é¢œè‰²æ ¼å¼</label>
                        <select id="colorFormatSelect" onchange="onColorFormatChange()">
                            <option value="rgb888" selected>RGB888 (æ•°æ®é‡ -25%)</option>
                            <option value="rgba">RGBA (æ— éœ€è½¬æ¢)</option>
                        </select>
                    </div>

                    <div class="video-controls">
                        <button class="btn-secondary" onclick="showCurrentConfig()">
                            <span class="icon">ğŸ“Š</span> æŸ¥çœ‹å½“å‰é…ç½®
                        </button>
                    </div>
                </div>

                <div style="padding: 12px; background: #E3F2FD; border-radius: 8px; font-size: 13px; color: #1976D2;">
                    <strong>ğŸ’¡ ä¼˜åŒ–è¯´æ˜ï¼š</strong> Canvasæ¨¡å¼ä½¿ç”¨320px + RGB888æ ¼å¼ + SharedMemoryå®ç°é«˜æ€§èƒ½æ¸²æŸ“ã€‚å…³é—­éš”å¸§å¯è·å¾—æœ€é«˜å¸§ç‡ã€‚
                </div>
            </div>
        </div>

        <!-- Layeræ¨¡å¼Tab -->
        <div id="tab-layer" class="tab-content">
            <div class="card-content">
                <div class="settings-title">ğŸ“º è¯¦æƒ…é¡µæ’­æ”¾å™¨ï¼ˆåŒå±‚æ¸²æŸ“ï¼‰</div>

                <div id="video-detail" class="video-container"></div>

                <div class="progress-bar">
                    <div id="progress-detail" class="progress-fill"></div>
                </div>

                <div class="video-controls">
                    <button class="btn-primary" onclick="playDetail()">
                        <span class="icon">â–¶</span> æ’­æ”¾
                    </button>
                    <button class="btn-secondary" onclick="pauseDetail()">
                        <span class="icon">â¸</span> æš‚åœ
                    </button>
                    <button class="btn-secondary" onclick="seekDetail()">
                        <span class="icon">â©</span> è·³è½¬30s
                    </button>
                    <button class="btn-secondary" onclick="toggleMuteDetail()">
                        <span class="icon">ğŸ”‡</span> é™éŸ³
                    </button>
                    <button class="btn-danger" onclick="destroyDetail()">
                        <span class="icon">ğŸ—‘</span> é”€æ¯
                    </button>
                </div>

                <div id="status-detail" class="status">çŠ¶æ€: æœªåˆå§‹åŒ–</div>
            </div>
        </div>
    </div>

    <script src="js/HybridVideoPlayer.js"></script>
    <script>
        // è§†é¢‘URL
        const TEST_VIDEO_URL = 'https://www.w3schools.com/html/mov_bbb.mp4';
        const TEST_VIDEO_URL_2 = 'https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/360/Big_Buck_Bunny_360_10s_1MB.mp4';
        const TEST_VIDEO_URL_3 = 'https://media.w3.org/2010/05/sintel/trailer.mp4';

        // æ’­æ”¾å™¨å®ä¾‹
        let detailPlayer = null;
        let listPlayers = [];

        // è‡ªåŠ¨æ’­æ”¾å¼€å…³çŠ¶æ€
        let autoPlayEnabled = true;
        let currentPlayingIndex = -1;
        let lastVisibilityStates = [];

        // é»˜è®¤è®¾ç½®ï¼šå…³é—­éš”å¸§ï¼ˆå®æµ‹FPSæœ€é«˜ï¼‰
        let frameSkipEnabled = false;
        let useRGB888 = true;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${time}] ${message}`;
            logEl.appendChild(logItem);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            const logEl = document.getElementById('log');
            if (logEl) {
                logEl.innerHTML = '';
                log('æ—¥å¿—å·²æ¸…ç©º', 'info');
            }
        }

        // åˆå§‹åŒ–åˆ—è¡¨æ’­æ”¾å™¨
        function initListPlayers() {
            if (listPlayers.length > 0) {
                return;
            }

            log('åˆå§‹åŒ–åˆ—è¡¨æ’­æ”¾å™¨ï¼ˆCanvasæ¨¡å¼ï¼‰');

            const urls = [TEST_VIDEO_URL, TEST_VIDEO_URL_2, TEST_VIDEO_URL_3];

            urls.forEach((url, index) => {
                const containerId = `video-list-${index + 1}`;

                // è·å–é€‰æ‹©çš„åˆ†è¾¨ç‡
                const resolution = parseInt(document.getElementById('resolutionSelect').value);

                const player = new HybridVideoPlayer({
                    containerId: containerId,
                    renderMode: 'canvas',
                    audioFocusType: 'transient',
                    enableDolby: false,
                    maxFrameRate: 60,
                    autoPlay: false,
                    canvasResolution: resolution
                });

                player.on('playing', () => {
                    log(`è§†é¢‘${index + 1}å¼€å§‹æ’­æ”¾`, 'success');
                });

                player.on('error', (error) => {
                    log(`è§†é¢‘${index + 1}é”™è¯¯: ${error.message}`, 'error');
                });

                let frameCount = 0;
                let lastLogTime = Date.now();
                player.on('framerendered', () => {
                    frameCount++;
                    const now = Date.now();
                    if (now - lastLogTime > 3000) {
                        const fps = frameCount / 3;
                        log(`è§†é¢‘${index + 1} å®é™…FPS: ${fps.toFixed(1)}`, 'info');
                        frameCount = 0;
                        lastLogTime = now;
                    }
                });

                player._videoUrl = urls[index];
                listPlayers.push(player);
            });

            // åˆå§‹åŒ–å¯è§æ€§çŠ¶æ€ä¸ºå®é™…çŠ¶æ€ï¼ˆè€Œä¸æ˜¯å…¨falseï¼‰
            // è¿™æ ·æ»šåŠ¨æ—¶æ‰èƒ½æ­£ç¡®æ£€æµ‹åˆ°"ä¸å¯è§â†’å¯è§"çš„å˜åŒ–
            updateVisibilityStates();
        }

        // æ’­æ”¾æŒ‡å®šè§†é¢‘
        function playVideo(index) {
            initListPlayers();

            const player = listPlayers[index];
            if (player) {
                // æš‚åœå…¶ä»–è§†é¢‘
                listPlayers.forEach((p, i) => {
                    if (p && i !== index && currentPlayingIndex === i) {
                        p.pause();
                    }
                });

                player.play(player._videoUrl);
                currentPlayingIndex = index;
                log(`æ‰‹åŠ¨æ’­æ”¾è§†é¢‘${index + 1}`, 'success');
            }
        }

        // æš‚åœæŒ‡å®šè§†é¢‘
        function pauseVideo(index) {
            const player = listPlayers[index];
            if (player) {
                player.pause();
                if (currentPlayingIndex === index) {
                    currentPlayingIndex = -1;
                }
                log(`æš‚åœè§†é¢‘${index + 1}`);
            }
        }

        // æš‚åœæ‰€æœ‰è§†é¢‘
        function pauseAllList() {
            listPlayers.forEach((player, index) => {
                if (player) {
                    player.pause();
                }
            });
            currentPlayingIndex = -1;
            log('æš‚åœæ‰€æœ‰åˆ—è¡¨è§†é¢‘');
        }

        // é”€æ¯æ‰€æœ‰è§†é¢‘
        function destroyAllList() {
            listPlayers.forEach((player, index) => {
                if (player) {
                    player.destroy();
                    log(`é”€æ¯åˆ—è¡¨è§†é¢‘${index + 1}`, 'error');
                }
            });
            listPlayers = [];
            currentPlayingIndex = -1;
        }

        // åˆ‡æ¢è‡ªåŠ¨æ’­æ”¾
        function toggleAutoPlay() {
            autoPlayEnabled = document.getElementById('autoPlaySwitch').checked;
            log(`è‡ªåŠ¨æ’­æ”¾${autoPlayEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
        }

        // æ›´æ–°å¯è§æ€§çŠ¶æ€ï¼ˆä¸è§¦å‘æ’­æ”¾/æš‚åœï¼‰
        function updateVisibilityStates() {
            lastVisibilityStates = listPlayers.map((player, index) => {
                const container = document.getElementById(`video-list-${index + 1}`);
                if (!container) return false;

                const rect = container.getBoundingClientRect();
                const windowHeight = window.innerHeight;
                const visibleHeight = Math.min(rect.bottom, windowHeight) - Math.max(rect.top, 0);
                const visibleRatio = Math.max(0, visibleHeight) / rect.height;
                return visibleRatio > 0.3;
            });
        }

        // ç›‘å¬æ»šåŠ¨ï¼ˆå¿«é€Ÿå“åº”ï¼‰
        let scrollTimer = null;
        window.addEventListener('scroll', () => {
            if (!autoPlayEnabled || listPlayers.length === 0) return;

            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                checkVisibilityAndPlayPause();
            }, 100); // å‡å°‘å»¶è¿Ÿä»200msåˆ°100msï¼Œæ›´å¿«å“åº”
        }, { passive: true });

        // æ£€æµ‹å¯è§æ€§å¹¶è‡ªåŠ¨åˆ‡æ¢æ’­æ”¾ï¼ˆå®æ—¶æ£€æµ‹ï¼Œä¸ä¾èµ–çŠ¶æ€å˜åŒ–ï¼‰
        function checkVisibilityAndPlayPause() {
            if (!autoPlayEnabled) return;

            let mostVisibleIndex = -1;
            let maxVisibleRatio = 0;

            // æ‰¾å‡ºå½“å‰æœ€å¯è§çš„è§†é¢‘
            listPlayers.forEach((player, index) => {
                const container = document.getElementById(`video-list-${index + 1}`);
                if (!container) return;

                const rect = container.getBoundingClientRect();
                const windowHeight = window.innerHeight;
                const visibleHeight = Math.min(rect.bottom, windowHeight) - Math.max(rect.top, 0);
                const visibleRatio = Math.max(0, visibleHeight) / rect.height;

                if (visibleRatio > maxVisibleRatio) {
                    maxVisibleRatio = visibleRatio;
                    mostVisibleIndex = index;
                }
            });

            // å¦‚æœæ‰¾åˆ°å¯è§è§†é¢‘ï¼ˆå¯è§åº¦>20%å³å¯åˆ‡æ¢ï¼Œæ›´çµæ•ï¼‰
            if (mostVisibleIndex !== -1 && maxVisibleRatio > 0.2) {
                // å¦‚æœä¸æ˜¯å½“å‰æ’­æ”¾çš„è§†é¢‘ï¼Œåˆ™åˆ‡æ¢
                if (currentPlayingIndex !== mostVisibleIndex) {
                    // æš‚åœä¹‹å‰çš„è§†é¢‘
                    if (currentPlayingIndex !== -1) {
                        const previousPlayer = listPlayers[currentPlayingIndex];
                        if (previousPlayer) {
                            previousPlayer.pause();
                            log(`åˆ‡æ¢æ’­æ”¾ï¼šæš‚åœè§†é¢‘${currentPlayingIndex + 1}`);
                        }
                    }

                    // æ’­æ”¾æ–°è§†é¢‘
                    const newPlayer = listPlayers[mostVisibleIndex];
                    if (newPlayer) {
                        newPlayer.play(newPlayer._videoUrl);
                        currentPlayingIndex = mostVisibleIndex;
                        log(`åˆ‡æ¢æ’­æ”¾ï¼šæ’­æ”¾è§†é¢‘${mostVisibleIndex + 1} (å¯è§åº¦${(maxVisibleRatio * 100).toFixed(0)}%)`, 'success');
                    }
                }
            }
            // å¦‚æœæ²¡æœ‰è¶³å¤Ÿå¯è§çš„è§†é¢‘ï¼ˆéƒ½çœ‹ä¸åˆ°äº†ï¼‰ï¼Œæš‚åœå½“å‰æ’­æ”¾
            else if (currentPlayingIndex !== -1 && maxVisibleRatio < 0.1) {
                const currentPlayer = listPlayers[currentPlayingIndex];
                if (currentPlayer) {
                    currentPlayer.pause();
                    log(`è§†é¢‘${currentPlayingIndex + 1}ä¸å¯è§ï¼Œå·²æš‚åœ`);
                    currentPlayingIndex = -1;
                }
            }
        }

        // å¸§ç‡æ§åˆ¶
        function onFrameRateChange() {
            if (!window.NativeVideoPlayer) {
                log('Native bridge ä¸å¯ç”¨', 'error');
                return;
            }

            const value = document.getElementById('frameRateSelect').value;

            if (value === 'disabled') {
                window.NativeVideoPlayer.setFrameSkipEnabled(false);
                log('å…³é—­éš”å¸§ä¼ è¾“ï¼ˆæœ€é«˜FPSï¼‰', 'success');
            } else {
                const fps = parseInt(value);
                const interval = 60 / fps; // è®¡ç®—é—´éš”
                window.NativeVideoPlayer.setFrameSkipEnabled(true);
                window.NativeVideoPlayer.setFrameSkipInterval(Math.round(interval));
                log(`è®¾ç½®å¸§ç‡: ${fps}fps`, 'success');
            }
        }

        // é¢œè‰²æ ¼å¼æ§åˆ¶
        function onColorFormatChange() {
            if (!window.NativeVideoPlayer) {
                log('Native bridge ä¸å¯ç”¨', 'error');
                return;
            }

            const value = document.getElementById('colorFormatSelect').value;
            const useRGB = value === 'rgb888';

            window.NativeVideoPlayer.setColorFormat(useRGB);
            log(`è®¾ç½®é¢œè‰²æ ¼å¼: ${useRGB ? 'RGB888 (æ•°æ®é‡-25%)' : 'RGBA (æ— éœ€è½¬æ¢)'}`, 'success');
        }

        // è¯¦æƒ…é¡µæ’­æ”¾å™¨
        function initDetailPlayer() {
            if (detailPlayer) {
                return detailPlayer;
            }

            log('åˆå§‹åŒ–è¯¦æƒ…é¡µæ’­æ”¾å™¨ï¼ˆåŒå±‚æ¸²æŸ“æ¨¡å¼ï¼‰');

            detailPlayer = new HybridVideoPlayer({
                containerId: 'video-detail',
                renderMode: 'layer',
                audioFocusType: 'gain',
                enableDolby: true,
                autoPlay: false
            });

            detailPlayer.on('prepared', () => {
                log('è¯¦æƒ…é¡µæ’­æ”¾å™¨å‡†å¤‡å®Œæˆ', 'success');
                updateStatus('detail', 'å‡†å¤‡å®Œæˆ');
            });

            detailPlayer.on('playing', () => {
                log('è¯¦æƒ…é¡µæ’­æ”¾å™¨å¼€å§‹æ’­æ”¾', 'success');
                updateStatus('detail', 'æ’­æ”¾ä¸­');
            });

            detailPlayer.on('paused', () => {
                log('è¯¦æƒ…é¡µæ’­æ”¾å™¨æš‚åœ');
                updateStatus('detail', 'å·²æš‚åœ');
            });

            detailPlayer.on('ended', () => {
                log('è¯¦æƒ…é¡µæ’­æ”¾å™¨æ’­æ”¾å®Œæˆ', 'success');
                updateStatus('detail', 'æ’­æ”¾å®Œæˆ');
            });

            detailPlayer.on('error', (error) => {
                log(`è¯¦æƒ…é¡µæ’­æ”¾å™¨é”™è¯¯: ${error.message}`, 'error');
                updateStatus('detail', `é”™è¯¯: ${error.message}`);
            });

            detailPlayer.on('progress', (current, duration) => {
                const percent = (current / duration) * 100;
                document.getElementById('progress-detail').style.width = percent + '%';
                updateStatus('detail', `æ’­æ”¾ä¸­ ${formatTime(current)} / ${formatTime(duration)}`);
            });

            return detailPlayer;
        }

        function playDetail() {
            const player = initDetailPlayer();
            player.play(TEST_VIDEO_URL);
            log('å¼€å§‹æ’­æ”¾è¯¦æƒ…é¡µè§†é¢‘');
        }

        function pauseDetail() {
            if (detailPlayer) {
                detailPlayer.pause();
                log('æš‚åœè¯¦æƒ…é¡µè§†é¢‘');
            }
        }

        function seekDetail() {
            if (detailPlayer) {
                detailPlayer.seek(30);
                log('è·³è½¬åˆ°30ç§’');
            }
        }

        let isMuted = false;
        function toggleMuteDetail() {
            if (detailPlayer) {
                isMuted = !isMuted;
                detailPlayer.setMuted(isMuted);
                log(isMuted ? 'é™éŸ³' : 'å–æ¶ˆé™éŸ³');
            }
        }

        function destroyDetail() {
            if (detailPlayer) {
                detailPlayer.destroy();
                detailPlayer = null;
                log('é”€æ¯è¯¦æƒ…é¡µæ’­æ”¾å™¨', 'error');
                updateStatus('detail', 'å·²é”€æ¯');
            }
        }

        // Tabåˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');

            log('åˆ‡æ¢åˆ° ' + (tabName === 'canvas' ? 'Canvasæ¨¡å¼' : 'Layeræ¨¡å¼'), 'info');
        }

        // å·¥å…·å‡½æ•°
        function updateStatus(id, status) {
            const statusEl = document.getElementById(`status-${id}`);
            if (statusEl) {
                statusEl.textContent = `çŠ¶æ€: ${status}`;
            }
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        // æŸ¥çœ‹å½“å‰é…ç½®
        function showCurrentConfig() {
            if (!window.NativeVideoPlayer) {
                log('Native bridge ä¸å¯ç”¨', 'error');
                return;
            }

            try {
                const configJson = window.NativeVideoPlayer.getFrameSkipConfig();
                const config = JSON.parse(configJson);

                // è·å–å½“å‰å¸§ç‡é€‰æ‹©
                const frameRateValue = document.getElementById('frameRateSelect').value;
                let frameRateText = '';
                if (frameRateValue === 'disabled') {
                    frameRateText = 'å…³é—­éš”å¸§';
                } else {
                    frameRateText = frameRateValue + ' FPS';
                }

                // è·å–å½“å‰åˆ†è¾¨ç‡é€‰æ‹©
                const resolution = document.getElementById('resolutionSelect').value;

                log('â”â”â”â”â”â” å½“å‰é…ç½® â”â”â”â”â”â”', 'info');
                log(`è§†é¢‘åˆ†è¾¨ç‡: ${resolution}p`, 'info');
                log(`å¸§ç‡æ§åˆ¶: ${frameRateText}`, 'info');
                log(`éš”å¸§ä¼ è¾“: ${config.enabled ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
                log(`ä¼ è¾“é—´éš”: æ¯${config.interval}å¸§ä¼ 1å¸§`, 'info');
                log(`é¢œè‰²æ ¼å¼: ${config.useRGB888 ? 'RGB888 (æ•°æ®é‡-25%)' : 'RGBA (æ— éœ€è½¬æ¢)'}`, 'info');
                log(`è‡ªåŠ¨æ’­æ”¾: ${autoPlayEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
                log(`å½“å‰æ’­æ”¾: ${currentPlayingIndex === -1 ? 'æ— ' : 'è§†é¢‘' + (currentPlayingIndex + 1)}`, 'info');
                log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            } catch (e) {
                log('è·å–é…ç½®å¤±è´¥: ' + e.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ', 'success');
            log('Canvasæ¨¡å¼ï¼šå…³é—­éš”å¸§å¯è·å¾—æœ€é«˜FPSï¼ˆ~25ï¼‰');

            // åº”ç”¨é»˜è®¤è®¾ç½®
            if (window.NativeVideoPlayer) {
                window.NativeVideoPlayer.setFrameSkipEnabled(false);
                window.NativeVideoPlayer.setColorFormat(true); // RGB888
            }

            // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¼€å…³æ‰“å¼€ï¼Œåˆå§‹åŒ–æ’­æ”¾å™¨å¹¶æ£€æŸ¥å¯è§æ€§
            setTimeout(() => {
                if (autoPlayEnabled) {
                    initListPlayers();
                    // å»¶è¿Ÿä¸€ç‚¹å†æ£€æŸ¥å¯è§æ€§ï¼Œç¡®ä¿å¸ƒå±€å®Œæˆ
                    setTimeout(() => {
                        checkVisibilityAndPlayPause();
                        log('è‡ªåŠ¨æ’­æ”¾å·²å¯ç”¨ï¼Œæ£€æµ‹å¯è§è§†é¢‘', 'info');
                    }, 500);
                }
            }, 1000);
        });

        // é¡µé¢å¸è½½æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (detailPlayer) {
                detailPlayer.destroy();
            }
            listPlayers.forEach(player => {
                if (player) player.destroy();
            });
        });
    </script>
</body>
</html>
